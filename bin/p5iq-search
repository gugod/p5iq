#!/usr/bin/env perl
use v5.18;
use warnings;

use FindBin;
use lib "${FindBin::Bin}/../lib";

use P5iq;

use PPI;
use Getopt::Long;
use JSON qw(to_json);
use Elastijk;

sub search_p5iq_index {
    my ($query_string, $size) = @_;
    $size //= 10;

    my $es_query = P5iq::analyze_for_query( PPI::Document->new( \$query_string ) );

    my ($status, $res) = P5iq->es->search(
        index => "p5iq",
        body  => {
            query => $es_query,
            size  => $size,
        }
    );
    if ($status eq '200') {
        for (@{ $res->{hits}{hits} }) {
            my @loc = split("\0", $_->{_source}{location});
            say join(":", $_->{_source}{file}, $loc[0], $loc[1]) . "\n" . $_->{_source}{content} . "\n";
        }
    } else {
        say "Query Error: " . to_json($res);
    }
}

GetOptions(
    "s|size=i" => \(my $size)
);
my $query = shift(@ARGV) or die "query required";

search_p5iq_index($query, $size);
